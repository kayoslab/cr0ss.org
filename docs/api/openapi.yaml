openapi: 3.0.3
info:
  title: CR0SS.org API
  description: |
    Personal website API for habit tracking, AI chat, search, and content management.

    ## Authentication
    Most endpoints require authentication via the `X-Secret` header containing your secret token.
    Dashboard endpoints require the `X-Admin-Secret` header for enhanced security.

    ## Rate Limiting
    All endpoints are rate limited. Rate limit headers are included in responses:
    - `Retry-After`: Seconds until retry is allowed (when rate limited)

    Rate limits vary by endpoint:
    - AI Chat: 10 requests per 12 hours
    - Search: 100 requests per 60 seconds
    - Habits: 30 requests per 60 seconds
    - Dashboard: 30 requests per 60 seconds
    - Revalidation: 5 requests per 300 seconds (5 minutes)

  version: 1.0.0
  contact:
    name: CR0SS
    url: https://cr0ss.org

servers:
  - url: https://cr0ss.org/api
    description: Production server
  - url: http://localhost:3000/api
    description: Development server

security:
  - SecretAuth: []

tags:
  - name: AI
    description: AI-powered features (chat, reindexing)
  - name: Search
    description: Algolia-powered search and analytics
  - name: Habits
    description: Personal habit tracking (coffee, workouts, daily rituals, goals)
  - name: Content
    description: Content management and featured posts
  - name: Dashboard
    description: Analytics and dashboard data
  - name: Location
    description: Location tracking
  - name: Auth
    description: Authentication status

paths:
  /v1/dashboard/coffee/summary:
    get:
      tags: [Dashboard]
      summary: Get coffee consumption summary
      description: |
        Returns coffee consumption summary for a specific date.
        Includes total cups consumed and breakdown by brew method.

        **Rate Limit:** 30 requests per 60 seconds
        **Cache:** 1 minute (realtime)
      security:
        - AdminAuth: []
      parameters:
        - name: date
          in: query
          description: Date in YYYY-MM-DD format (defaults to today in Europe/Berlin timezone)
          schema:
            type: string
            format: date
            pattern: '^\d{4}-\d{2}-\d{2}$'
          example: "2025-12-05"
      responses:
        '200':
          description: Coffee summary
          content:
            application/json:
              schema:
                type: object
                properties:
                  date:
                    type: string
                    format: date
                    description: Date of the summary
                    example: "2025-12-05"
                  cups:
                    type: integer
                    minimum: 0
                    description: Total number of cups consumed
                    example: 3
                  brewMethods:
                    type: array
                    description: Breakdown of brew methods used
                    items:
                      type: object
                      properties:
                        type:
                          type: string
                          description: Brew method type
                          example: "espresso"
                        count:
                          type: integer
                          minimum: 0
                          description: Number of cups with this method
                          example: 2
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'
        '500':
          $ref: '#/components/responses/ServerError'

  /v1/dashboard/coffee/timeline:
    get:
      tags: [Dashboard]
      summary: Get coffee consumption timeline
      description: |
        Returns coffee consumption timeline for a date range.
        Shows cups per period and average caffeine content.

        **Rate Limit:** 30 requests per 60 seconds
        **Cache:** 5 minutes (frequent)
      security:
        - AdminAuth: []
      parameters:
        - name: start_date
          in: query
          required: true
          description: Start date in YYYY-MM-DD format
          schema:
            type: string
            format: date
            pattern: '^\d{4}-\d{2}-\d{2}$'
          example: "2025-12-01"
        - name: end_date
          in: query
          required: true
          description: End date in YYYY-MM-DD format
          schema:
            type: string
            format: date
            pattern: '^\d{4}-\d{2}-\d{2}$'
          example: "2025-12-05"
        - name: granularity
          in: query
          description: Time period granularity
          schema:
            type: string
            enum: [day, week, month]
            default: day
          example: "day"
      responses:
        '200':
          description: Coffee timeline
          content:
            application/json:
              schema:
                type: object
                properties:
                  timeline:
                    type: array
                    items:
                      type: object
                      properties:
                        period:
                          type: string
                          description: Time period (YYYY-MM-DD for day, YYYY-Www for week, YYYY-MM for month)
                          example: "2025-12-01"
                        cups_count:
                          type: integer
                          minimum: 0
                          description: Number of cups in this period
                          example: 3
                        avg_caffeine_mg:
                          type: integer
                          minimum: 0
                          description: Average caffeine content per cup (mg)
                          example: 100
                  total_cups:
                    type: integer
                    minimum: 0
                    description: Total cups in the entire range
                    example: 15
                  avg_cups_per_day:
                    type: number
                    format: float
                    minimum: 0
                    description: Average cups per day
                    example: 3.0
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'
        '500':
          $ref: '#/components/responses/ServerError'

  /v1/dashboard/coffee/caffeine-curve:
    get:
      tags: [Dashboard]
      summary: Get caffeine curve for a date
      description: |
        Returns modeled caffeine curve showing intake and body levels throughout the day.
        Uses pharmacokinetic modeling based on user's body profile.

        **Rate Limit:** 30 requests per 60 seconds
        **Cache:** 1 minute (realtime)
      security:
        - AdminAuth: []
      parameters:
        - name: date
          in: query
          description: Date in YYYY-MM-DD format (defaults to today in Europe/Berlin timezone)
          schema:
            type: string
            format: date
            pattern: '^\d{4}-\d{2}-\d{2}$'
          example: "2025-12-05"
        - name: resolution
          in: query
          description: Minutes between data points
          schema:
            type: integer
            minimum: 15
            maximum: 240
            default: 60
          example: 60
      responses:
        '200':
          description: Caffeine curve data
          content:
            application/json:
              schema:
                type: object
                properties:
                  date:
                    type: string
                    format: date
                    description: Date of the curve
                    example: "2025-12-05"
                  series:
                    type: array
                    description: Time series data points
                    items:
                      type: object
                      properties:
                        time:
                          type: string
                          format: date-time
                          description: ISO timestamp in Berlin timezone
                          example: "2025-12-05T08:00:00.000Z"
                        intake_mg:
                          type: integer
                          minimum: 0
                          description: Cumulative caffeine intake (mg)
                          example: 80
                        body_mg:
                          type: integer
                          minimum: 0
                          description: Modeled body caffeine level (mg)
                          example: 85
                  body_profile:
                    type: object
                    description: User's caffeine metabolism parameters
                    properties:
                      half_life_hours:
                        type: number
                        format: float
                        description: Caffeine half-life in hours
                        example: 5.0
                      sensitivity:
                        type: number
                        format: float
                        description: Caffeine sensitivity multiplier
                        example: 1.0
                      bioavailability:
                        type: number
                        format: float
                        description: Caffeine bioavailability
                        example: 0.9
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'
        '500':
          $ref: '#/components/responses/ServerError'

  /v1/dashboard/workouts/summary:
    get:
      tags: [Dashboard]
      summary: Get workouts summary
      description: |
        Returns workout summary for a specific period (today, week, or month).
        Includes workout types breakdown, totals, and streak information.

        **Rate Limit:** 30 requests per 60 seconds
        **Cache:** 1 minute (realtime)
      security:
        - AdminAuth: []
      parameters:
        - name: period
          in: query
          description: Period to summarize
          schema:
            type: string
            enum: [today, week, month]
            default: month
          example: "week"
      responses:
        '200':
          description: Workouts summary
          content:
            application/json:
              schema:
                type: object
                properties:
                  period:
                    type: string
                    description: Period of the summary
                    example: "week"
                  workout_types:
                    type: array
                    description: Breakdown by workout type
                    items:
                      type: object
                      properties:
                        type:
                          type: string
                          description: Workout type
                          example: "running"
                        count:
                          type: integer
                          minimum: 0
                          description: Number of workouts
                          example: 3
                        total_duration_min:
                          type: integer
                          minimum: 0
                          description: Total duration in minutes
                          example: 150
                        avg_duration_min:
                          type: number
                          format: float
                          minimum: 0
                          description: Average duration per workout
                          example: 50.0
                  total_workouts:
                    type: integer
                    minimum: 0
                    description: Total number of workouts
                    example: 4
                  total_duration_min:
                    type: integer
                    minimum: 0
                    description: Total duration across all workouts
                    example: 210
                  streaks:
                    type: object
                    description: Workout streaks (max 2 days gap allowed)
                    properties:
                      current:
                        type: integer
                        minimum: 0
                        description: Current workout streak
                        example: 3
                      longest:
                        type: integer
                        minimum: 0
                        description: Longest streak on record
                        example: 7
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'
        '500':
          $ref: '#/components/responses/ServerError'

  /v1/dashboard/workouts/heatmap:
    get:
      tags: [Dashboard]
      summary: Get workouts heatmap
      description: |
        Returns heatmap data for workout visualization.
        Shows daily workout duration (and distance for running) over a period.

        **Rate Limit:** 30 requests per 60 seconds
        **Cache:** 5 minutes (frequent)
      security:
        - AdminAuth: []
      parameters:
        - name: days
          in: query
          description: Number of days to include
          schema:
            type: integer
            minimum: 1
            maximum: 365
            default: 60
          example: 60
        - name: workout_type
          in: query
          description: Filter by specific workout type
          schema:
            type: string
          example: "running"
      responses:
        '200':
          description: Workouts heatmap
          content:
            application/json:
              schema:
                type: object
                properties:
                  heatmap:
                    type: array
                    description: Daily workout data (includes all days, even with zero activity)
                    items:
                      type: object
                      properties:
                        date:
                          type: string
                          format: date
                          description: Date
                          example: "2025-10-06"
                        duration_min:
                          type: integer
                          minimum: 0
                          description: Total duration in minutes
                          example: 45
                        distance_km:
                          type: number
                          format: float
                          minimum: 0
                          description: Distance in kilometers (only for running workouts)
                          example: 8.5
                  stats:
                    type: object
                    description: Summary statistics for the period
                    properties:
                      active_days:
                        type: integer
                        minimum: 0
                        description: Number of days with workouts
                        example: 30
                      total_duration_min:
                        type: integer
                        minimum: 0
                        description: Total duration across all days
                        example: 1500
                      avg_duration_min:
                        type: number
                        format: float
                        minimum: 0
                        description: Average duration on active days
                        example: 50.0
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'
        '500':
          $ref: '#/components/responses/ServerError'

  /v1/dashboard/workouts/running/stats:
    get:
      tags: [Dashboard]
      summary: Get running statistics
      description: |
        Returns detailed running statistics for a specific period.
        Includes totals, pace, personal records, and monthly goal progress.

        **Rate Limit:** 30 requests per 60 seconds
        **Cache:** 1 minute (realtime)
      security:
        - AdminAuth: []
      parameters:
        - name: period
          in: query
          description: Period to analyze
          schema:
            type: string
            enum: [month, year, all]
            default: month
          example: "month"
      responses:
        '200':
          description: Running statistics
          content:
            application/json:
              schema:
                type: object
                properties:
                  period:
                    type: string
                    description: Period of the stats
                    example: "month"
                  total_runs:
                    type: integer
                    minimum: 0
                    description: Total number of runs
                    example: 12
                  total_distance_km:
                    type: number
                    format: float
                    minimum: 0
                    description: Total distance in kilometers
                    example: 85.5
                  total_duration_min:
                    type: integer
                    minimum: 0
                    description: Total duration in minutes
                    example: 600
                  avg_pace_sec_per_km:
                    type: number
                    format: float
                    minimum: 0
                    description: Average pace in seconds per kilometer
                    example: 421.0
                  personal_records:
                    type: object
                    description: All-time personal records
                    properties:
                      longest_run_km:
                        type: number
                        format: float
                        minimum: 0
                        description: Longest run distance
                        example: 21.1
                      longest_run_date:
                        type: string
                        format: date
                        description: Date of longest run
                        example: "2025-11-15"
                      fastest_pace_sec_per_km:
                        type: number
                        format: float
                        minimum: 0
                        description: Fastest pace achieved
                        example: 240.0
                      fastest_pace_date:
                        type: string
                        format: date
                        description: Date of fastest pace
                        example: "2025-10-20"
                  monthly_progress:
                    type: object
                    description: Monthly goal progress (only included when period=month)
                    properties:
                      target_km:
                        type: number
                        format: float
                        minimum: 0
                        description: Monthly distance target
                        example: 100.0
                      current_km:
                        type: number
                        format: float
                        minimum: 0
                        description: Current distance this month
                        example: 85.5
                      remaining_km:
                        type: number
                        format: float
                        description: Remaining distance to target
                        example: 14.5
                      progress_pct:
                        type: number
                        format: float
                        minimum: 0
                        maximum: 100
                        description: Progress percentage
                        example: 85.5
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'
        '500':
          $ref: '#/components/responses/ServerError'

  /v1/dashboard/habits/today:
    get:
      tags: [Dashboard]
      summary: Get today's habits data
      description: |
        Returns habit tracking data for a specific date.
        Includes steps, reading, outdoor time, writing, coding, focus, and sleep.

        **Rate Limit:** 30 requests per 60 seconds
        **Cache:** 30 seconds (highest freshness priority)
      security:
        - AdminAuth: []
      parameters:
        - name: date
          in: query
          description: Date in YYYY-MM-DD format (defaults to today in Europe/Berlin timezone)
          schema:
            type: string
            format: date
            pattern: '^\d{4}-\d{2}-\d{2}$'
          example: "2025-12-05"
      responses:
        '200':
          description: Habits data
          content:
            application/json:
              schema:
                type: object
                properties:
                  date:
                    type: string
                    format: date
                    description: Date of the data
                    example: "2025-12-05"
                  steps:
                    type: integer
                    minimum: 0
                    description: Step count
                    example: 12500
                  reading_minutes:
                    type: integer
                    minimum: 0
                    description: Minutes spent reading
                    example: 45
                  outdoor_minutes:
                    type: integer
                    minimum: 0
                    description: Minutes spent outdoors
                    example: 60
                  writing_minutes:
                    type: integer
                    minimum: 0
                    description: Minutes spent writing
                    example: 90
                  coding_minutes:
                    type: integer
                    minimum: 0
                    description: Minutes spent coding
                    example: 240
                  focus_minutes:
                    type: integer
                    minimum: 0
                    description: Minutes in deep focus
                    example: 180
                  sleep_score:
                    type: integer
                    minimum: 0
                    maximum: 100
                    description: Sleep quality score (optional)
                    example: 85
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'
        '500':
          $ref: '#/components/responses/ServerError'

  /v1/dashboard/habits/consistency:
    get:
      tags: [Dashboard]
      summary: Get habit consistency metrics
      description: |
        Returns consistency metrics showing how often daily targets are met.
        Analyzes habit performance over a specified period.

        **Rate Limit:** 30 requests per 60 seconds
        **Cache:** 5 minutes (frequent)
      security:
        - AdminAuth: []
      parameters:
        - name: days
          in: query
          description: Number of days to analyze
          schema:
            type: integer
            minimum: 1
            maximum: 90
            default: 7
          example: 7
      responses:
        '200':
          description: Habit consistency metrics
          content:
            application/json:
              schema:
                type: object
                properties:
                  period_days:
                    type: integer
                    minimum: 1
                    description: Number of days analyzed
                    example: 7
                  habits:
                    type: array
                    description: Consistency data for each habit
                    items:
                      type: object
                      properties:
                        name:
                          type: string
                          description: Habit name
                          example: "Steps"
                        target:
                          type: number
                          format: float
                          description: Daily target value
                          example: 8000.0
                        days_met:
                          type: integer
                          minimum: 0
                          description: Number of days target was met
                          example: 5
                        consistency_pct:
                          type: number
                          format: float
                          minimum: 0
                          maximum: 100
                          description: Percentage of days target was met
                          example: 71.0
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'
        '500':
          $ref: '#/components/responses/ServerError'

  /v1/dashboard/habits/streaks:
    get:
      tags: [Dashboard]
      summary: Get habit streaks
      description: |
        Returns current and longest streaks for all habits.
        A streak is broken if a day doesn't meet the daily target.

        **Rate Limit:** 30 requests per 60 seconds
        **Cache:** 5 minutes (frequent)
      security:
        - AdminAuth: []
      responses:
        '200':
          description: Habit streaks
          content:
            application/json:
              schema:
                type: object
                properties:
                  streaks:
                    type: array
                    description: Streak data for each habit
                    items:
                      type: object
                      properties:
                        habit:
                          type: string
                          description: Habit name
                          example: "Steps"
                        current:
                          type: integer
                          minimum: 0
                          description: Current streak in days
                          example: 12
                        longest:
                          type: integer
                          minimum: 0
                          description: All-time longest streak
                          example: 45
                        target:
                          type: number
                          format: float
                          description: Daily target to maintain streak
                          example: 8000.0
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'
        '500':
          $ref: '#/components/responses/ServerError'

  /v1/dashboard/habits/trends:
    get:
      tags: [Dashboard]
      summary: Get habit trends
      description: |
        Returns time-series trends for specified habits over a period.
        Use for visualizing habit performance over time.

        **Rate Limit:** 30 requests per 60 seconds
        **Cache:** 5 minutes (frequent)
      security:
        - AdminAuth: []
      parameters:
        - name: habits
          in: query
          required: true
          description: Comma-separated habit names
          schema:
            type: string
            minLength: 1
          example: "writing_minutes,focus_minutes"
        - name: days
          in: query
          description: Number of days to fetch
          schema:
            type: integer
            minimum: 1
            maximum: 90
            default: 14
          example: 14
      responses:
        '200':
          description: Habit trends
          content:
            application/json:
              schema:
                type: object
                properties:
                  trends:
                    type: array
                    description: Daily data points
                    items:
                      type: object
                      properties:
                        date:
                          type: string
                          format: date
                          description: Date
                          example: "2025-12-01"
                        values:
                          type: object
                          description: Habit values for this date
                          additionalProperties:
                            type: integer
                            minimum: 0
                          example:
                            writing_minutes: 45
                            focus_minutes: 120
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'
        '500':
          $ref: '#/components/responses/ServerError'

  /v1/dashboard/goals:
    get:
      tags: [Dashboard]
      summary: Get all goals
      description: |
        Returns all goals organized by period (daily and monthly).
        Goals define target values for habits and activities.

        **Rate Limit:** 30 requests per 60 seconds
        **Cache:** 10 minutes (stable)
      security:
        - AdminAuth: []
      responses:
        '200':
          description: All goals
          content:
            application/json:
              schema:
                type: object
                properties:
                  daily:
                    type: object
                    description: Daily goal targets
                    additionalProperties:
                      type: number
                      format: float
                    example:
                      steps: 10000
                      reading_minutes: 30
                      outdoor_minutes: 30
                      writing_minutes: 60
                      coding_minutes: 120
                      focus_minutes: 180
                  monthly:
                    type: object
                    description: Monthly goal targets
                    additionalProperties:
                      type: number
                      format: float
                    example:
                      running_distance_km: 100
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'
        '500':
          $ref: '#/components/responses/ServerError'

  /v1/dashboard/goals/progress:
    get:
      tags: [Dashboard]
      summary: Get goal progress
      description: |
        Returns progress towards goals for daily and/or monthly periods.
        Shows current values, targets, and completion percentages.

        **Rate Limit:** 30 requests per 60 seconds
        **Cache:** 1 minute (realtime)
      security:
        - AdminAuth: []
      parameters:
        - name: period
          in: query
          description: Filter by period (returns both if not specified)
          schema:
            type: string
            enum: [daily, monthly]
          example: "daily"
      responses:
        '200':
          description: Goal progress
          content:
            application/json:
              schema:
                type: object
                properties:
                  daily:
                    type: array
                    description: Daily goal progress (optional)
                    items:
                      type: object
                      properties:
                        goal:
                          type: string
                          description: Goal name
                          example: "Steps"
                        target:
                          type: number
                          format: float
                          description: Target value
                          example: 10000.0
                        current:
                          type: number
                          format: float
                          description: Current value
                          example: 8500.0
                        progress_pct:
                          type: number
                          format: float
                          minimum: 0
                          maximum: 100
                          description: Progress percentage
                          example: 85.0
                        unit:
                          type: string
                          description: Unit of measurement
                          example: "steps"
                  monthly:
                    type: array
                    description: Monthly goal progress (optional)
                    items:
                      type: object
                      properties:
                        goal:
                          type: string
                          description: Goal name
                          example: "Running Distance Km"
                        target:
                          type: number
                          format: float
                          description: Target value
                          example: 100.0
                        current:
                          type: number
                          format: float
                          description: Current value
                          example: 45.5
                        progress_pct:
                          type: number
                          format: float
                          minimum: 0
                          maximum: 100
                          description: Progress percentage
                          example: 46.0
                        unit:
                          type: string
                          description: Unit of measurement
                          example: "km"
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'
        '500':
          $ref: '#/components/responses/ServerError'

  /chat:
    post:
      tags: [AI]
      summary: Chat with AI assistant
      description: |
        Send a message to the AI assistant powered by RAG (Retrieval Augmented Generation).
        Uses GPT-4o-mini and retrieves context from blog posts and knowledge base.

        **Rate Limit:** 10 requests per 12 hours
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [message]
              properties:
                message:
                  type: string
                  minLength: 1
                  maxLength: 500
                  description: User's question or message
                  example: "What are your thoughts on TypeScript?"
      responses:
        '200':
          description: Successful response
          content:
            application/json:
              schema:
                type: object
                properties:
                  response:
                    type: string
                    description: AI-generated response
                  model:
                    type: object
                    properties:
                      name:
                        type: string
                        example: "gpt-4o-mini"
                      provider:
                        type: string
                        example: "openai"
                  sources:
                    type: array
                    items:
                      type: object
                      properties:
                        title:
                          type: string
                        url:
                          type: string
                  timestamp:
                    type: integer
                    format: int64
                    description: Unix timestamp
        '400':
          $ref: '#/components/responses/ValidationError'
        '429':
          $ref: '#/components/responses/RateLimitError'
        '500':
          $ref: '#/components/responses/ServerError'

  /algolia/search:
    get:
      tags: [Search]
      summary: Search blog posts
      description: |
        Search through blog posts using Algolia.
        Supports both text search and click tracking.

        **Rate Limit:** 100 requests per 60 seconds
      security: []
      parameters:
        - name: q
          in: query
          description: Search query
          schema:
            type: string
          example: "typescript"
        - name: objectID
          in: query
          description: Object ID for click tracking (when provided, tracks click instead of searching)
          schema:
            type: string
      responses:
        '200':
          description: Search results or click tracking confirmation
          content:
            application/json:
              schema:
                oneOf:
                  - type: object
                    properties:
                      hits:
                        type: array
                        items:
                          $ref: '#/components/schemas/SearchHit'
                      queryID:
                        type: string
                        nullable: true
                  - type: object
                    properties:
                      success:
                        type: boolean
        '429':
          $ref: '#/components/responses/RateLimitError'
        '500':
          $ref: '#/components/responses/ServerError'

  /algolia/analytics:
    post:
      tags: [Search]
      summary: Track search analytics
      description: Track view or click events for Algolia Insights
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [objectID]
              properties:
                objectID:
                  type: string
                  description: Algolia object ID
                eventType:
                  type: string
                  enum: [view, click, recommendation_click]
                  default: view
                userToken:
                  type: string
                  description: User token for personalization
      responses:
        '200':
          description: Event tracked successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        '400':
          $ref: '#/components/responses/ValidationError'
        '500':
          $ref: '#/components/responses/ServerError'

  /habits/coffee:
    get:
      tags: [Habits]
      summary: Get available coffees
      description: |
        Retrieve list of available coffee beans from Contentful.
        Returns up to 20 coffee entries.

        **Rate Limit:** 30 requests per 60 seconds
      responses:
        '200':
          description: List of coffee beans
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Coffee'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'

    post:
      tags: [Habits]
      summary: Log coffee consumption
      description: |
        Log one or more coffee consumption events.
        Accepts single object or array of objects.

        **Rate Limit:** 30 requests per 60 seconds
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - $ref: '#/components/schemas/CoffeeLog'
                - type: array
                  items:
                    $ref: '#/components/schemas/CoffeeLog'
      responses:
        '200':
          description: Coffee log created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  inserted:
                    type: integer
                    description: Number of entries inserted
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'

  /habits/workout:
    post:
      tags: [Habits]
      summary: Log workout
      description: |
        Log a workout session (running, climbing, rowing, etc.)

        **Rate Limit:** 30 requests per 60 seconds
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WorkoutLog'
      responses:
        '200':
          description: Workout logged successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  id:
                    type: integer
                    description: Workout ID
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'

  /habits/day:
    post:
      tags: [Habits]
      summary: Log daily habits
      description: |
        Log daily habits like sleep, focus, steps, reading, etc.

        **Rate Limit:** 30 requests per 60 seconds
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DayLog'
      responses:
        '200':
          description: Day logged successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'

  /habits/goal:
    get:
      tags: [Habits]
      summary: Get monthly goals
      description: |
        Retrieve goals for the current month.

        **Rate Limit:** 30 requests per 60 seconds
      responses:
        '200':
          description: Monthly goals
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MonthlyGoals'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'

    post:
      tags: [Habits]
      summary: Update monthly goals
      description: |
        Update goals for the current month.
        Accepts partial updates.

        **Rate Limit:** 30 requests per 60 seconds
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MonthlyGoals'
      responses:
        '200':
          description: Goals updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'

  /habits/body:
    get:
      tags: [Habits]
      summary: Get body profile
      description: |
        Retrieve current body profile (weight, body fat, caffeine sensitivity, etc.)

        **Rate Limit:** 30 requests per 60 seconds
      responses:
        '200':
          description: Body profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BodyProfile'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'

    post:
      tags: [Habits]
      summary: Update body profile
      description: |
        Update body profile measurements.
        Accepts partial updates.

        **Rate Limit:** 30 requests per 60 seconds
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BodyProfileUpdate'
      responses:
        '200':
          description: Profile updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  profile:
                    $ref: '#/components/schemas/BodyProfile'
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'

  /featured-posts:
    get:
      tags: [Content]
      summary: Get featured blog posts
      description: |
        Retrieve trending or recent blog posts.
        Returns 3 posts based on Algolia analytics.
        Falls back to recent posts if no trending data available.
      security: []
      responses:
        '200':
          description: Featured posts
          content:
            application/json:
              schema:
                type: object
                properties:
                  posts:
                    type: array
                    items:
                      $ref: '#/components/schemas/BlogPost'
                  isTrending:
                    type: boolean
                    description: Whether posts are trending (true) or recent fallback (false)
        '500':
          $ref: '#/components/responses/ServerError'

  /location:
    post:
      tags: [Location]
      summary: Update location
      description: |
        Update current location data.

        **Rate Limit:** 10 requests per 60 seconds
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [latitude, longitude]
              properties:
                latitude:
                  type: number
                  format: double
                longitude:
                  type: number
                  format: double
                accuracy:
                  type: number
                  format: double
      responses:
        '200':
          description: Location updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'

  /revalidate:
    post:
      tags: [Content]
      summary: Revalidate cache
      description: |
        Trigger revalidation of cached content and indexes.
        Can revalidate dashboard, blog posts, or Algolia index.

        **Rate Limit:** 5 requests per 300 seconds (5 minutes)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [target]
              properties:
                target:
                  type: string
                  enum: [dashboard, blog, algolia]
                  description: What to revalidate
                slug:
                  type: string
                  description: Blog post slug (required when target=blog)
      responses:
        '200':
          description: Revalidation triggered
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  message:
                    type: string
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'

  /ai/reindex-blog:
    post:
      tags: [AI]
      summary: Reindex blog posts for AI
      description: |
        Reindex all blog posts into vector database for RAG.
        This is a long-running operation (up to 60 seconds).

        **Rate Limit:** 5 requests per 300 seconds (5 minutes)
      responses:
        '200':
          description: Reindexing completed
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  indexed:
                    type: integer
                    description: Number of posts indexed
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'
        '500':
          $ref: '#/components/responses/ServerError'

  /ai/reindex-knowledge:
    post:
      tags: [AI]
      summary: Reindex knowledge base for AI
      description: |
        Reindex knowledge base entries into vector database for RAG.

        **Rate Limit:** 5 requests per 300 seconds (5 minutes)
      responses:
        '200':
          description: Reindexing completed
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  indexed:
                    type: integer
                    description: Number of entries indexed
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '429':
          $ref: '#/components/responses/RateLimitError'
        '500':
          $ref: '#/components/responses/ServerError'

  /auth/check:
    get:
      tags: [Auth]
      summary: Check authentication status
      description: Verify if the provided secret is valid
      responses:
        '200':
          description: Authentication valid
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
        '401':
          $ref: '#/components/responses/UnauthorizedError'

components:
  securitySchemes:
    SecretAuth:
      type: apiKey
      in: header
      name: X-Secret
      description: Secret token for authentication
    AdminAuth:
      type: apiKey
      in: header
      name: X-Admin-Secret
      description: Admin secret token for dashboard endpoints

  schemas:
    SearchHit:
      type: object
      properties:
        objectID:
          type: string
        title:
          type: string
        summary:
          type: string
        author:
          type: string
        url:
          type: string
        image:
          type: string
          nullable: true
        categories:
          type: array
          items:
            type: string

    Coffee:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        roaster:
          type: string
        origin:
          type: object
          properties:
            name:
              type: string
            id:
              type: string
        process:
          type: string
        roastLevel:
          type: string

    CoffeeLog:
      type: object
      required: [date, type]
      properties:
        date:
          type: string
          format: date
          example: "2025-01-15"
        time:
          type: string
          description: Berlin time (HH:MM) or full ISO timestamp
          example: "14:30"
        type:
          type: string
          enum: [espresso, v60, chemex, moka, aero, cold_brew, other]
        amount_ml:
          type: integer
          minimum: 0
          example: 250
        coffee_cf_id:
          type: string
          description: Contentful Entry ID of the coffee bean

    WorkoutLog:
      type: object
      required: [date, workout_type, duration_min]
      properties:
        date:
          type: string
          format: date
          example: "2025-01-15"
        workout_type:
          type: string
          enum: [running, climbing, bouldering, rowing, cycling, hiking, strength, other]
        duration_min:
          type: integer
          minimum: 1
          example: 45
        intensity:
          type: string
          enum: [low, moderate, high, max]
        perceived_effort:
          type: integer
          minimum: 1
          maximum: 10
          description: RPE scale 1-10
        details:
          type: object
          description: Workout-specific details (distance_km for running, routes for climbing, etc.)
          additionalProperties: true
        notes:
          type: string

    DayLog:
      type: object
      required: [date]
      properties:
        date:
          type: string
          format: date
        sleep_score:
          type: integer
          minimum: 0
          maximum: 100
        focus_minutes:
          type: integer
          minimum: 0
        steps:
          type: integer
          minimum: 0
        reading_minutes:
          type: integer
          minimum: 0
        outdoor_minutes:
          type: integer
          minimum: 0
        writing_minutes:
          type: integer
          minimum: 0
        coding_minutes:
          type: integer
          minimum: 0
        journaled:
          type: boolean
        extras:
          type: object
          additionalProperties:
            type: number

    MonthlyGoals:
      type: object
      properties:
        running_distance_km:
          type: number
          minimum: 0
        steps:
          type: number
          minimum: 0
        reading_minutes:
          type: number
          minimum: 0
        outdoor_minutes:
          type: number
          minimum: 0
        writing_minutes:
          type: number
          minimum: 0
        coding_minutes:
          type: number
          minimum: 0
        focus_minutes:
          type: number
          minimum: 0

    BodyProfile:
      type: object
      properties:
        id:
          type: integer
        measured_at:
          type: string
          format: date-time
        weight_kg:
          type: number
          format: double
        body_fat_pct:
          type: number
          format: double
        muscle_mass_kg:
          type: number
          format: double
        caffeine_sensitivity:
          type: number
          format: double
          description: Sensitivity multiplier (default 1.0)
        half_life_hours:
          type: number
          format: double
          description: Caffeine half-life in hours (default 5.0)
        bioavailability:
          type: number
          format: double
          description: Caffeine bioavailability (default 0.9)
        created_at:
          type: string
          format: date-time

    BodyProfileUpdate:
      type: object
      properties:
        measured_at:
          type: string
          format: date-time
        weight_kg:
          type: number
          format: double
        body_fat_pct:
          type: number
          format: double
        muscle_mass_kg:
          type: number
          format: double
        caffeine_sensitivity:
          type: number
          format: double
        half_life_hours:
          type: number
          format: double
        bioavailability:
          type: number
          format: double

    BlogPost:
      type: object
      properties:
        slug:
          type: string
        title:
          type: string
        summary:
          type: string
        author:
          type: string
        publishedAt:
          type: string
          format: date-time
        heroImage:
          type: string
        categories:
          type: array
          items:
            type: string

    Error:
      type: object
      properties:
        error:
          type: string
          description: Error message
        code:
          type: string
          description: Error code
        details:
          description: Additional error details
        timestamp:
          type: integer
          format: int64

  responses:
    UnauthorizedError:
      description: Authentication required or invalid
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Unauthorized"
            code: "UNAUTHORIZED"
            timestamp: 1706184000000

    ValidationError:
      description: Invalid request data
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Invalid request"
            code: "VALIDATION_ERROR"
            details:
              fieldErrors:
                message: ["String must contain at least 1 character(s)"]
            timestamp: 1706184000000

    RateLimitError:
      description: Rate limit exceeded
      headers:
        Retry-After:
          description: Seconds until retry is allowed
          schema:
            type: integer
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Too many requests"
            code: "RATE_LIMIT_EXCEEDED"
            details:
              retryAfterSec: 300
              limit: 10
              windowHours: 12
            timestamp: 1706184000000

    ServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Internal server error"
            code: "INTERNAL_ERROR"
            timestamp: 1706184000000
